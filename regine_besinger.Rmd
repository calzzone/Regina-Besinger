---
title: "Graduation Thesis"
subtitle: "Graduation Thesis"
author: "Regine Besinger"
output:
  word_document:
    fig_caption: yes
    fig_height: 5
    fig_width: 5
    keep_md: no
    toc: yes
    reference_docx: word_template.docx
  html_document: 
    df_print: kable
    fig_caption: yes
    fontface: Arial
    fontsize: 11pt
    keep_md: yes
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float: no
---

https://rpubs.com/alex_istrate/wm73mh1qivcswbhoi9i0kk53

# General part

# Special part

## Introduction

### Objectives

## Methods

### Statisitcal analysis of the data

To describe the quantitative variables, we used histograms and we calculated the arithmetic means ±standard deviation (SD) [with 95% confidence interval (CI)], as well as the extreme and median values.
For the qualitative variables, we used pie or bar charts and calculated the absolute and percentual frequencies of the formed categories.

To study the relationships between quantitative and qualitative variables, we used the T or Mann-Whitney (MW) tests if they were binary, respectively ANOVA or Kruskal-Wallis (KW) if they had more categories. We presented the p values generated by these tests as well as the means ±SD of the groups and the difference of the means with associated 95% CI. We graphically presented the results in the form of box plots.
To study the relationships between the quantitative variables we used the Spearman correlation coefficient (R), with the associated p-value and graphically presented the relations as scatter plots, on which we added the regression line.
To describe the relationships between the qualitative variables we used the Chi² or Fisher test and the Cramer phi or V and Odds-Ratio (OR) / Relative Risk (RR) indicators with 95% CI. We graphically presented the results in the form of pie or bar charts.

We used Microsoft Excel 2016 for database management. For all statistical analyzes and subsequent graphs we used R 3.6.2 [1]. We considered p <0.05 to be statistically significant and p <0.10 to show only a tendency towards statistical significance.

```{r setup, echo=F, message=F, warning=F, results='hide'}
library(ggplot2)
#library(ggExtra) # ggMarginal()
#library(cowplot) # plot_grid
library(ggpubr)
library(ggthemes)
#library(ggcorrplot)
#library(GGally) #ggpairs
library(dplyr)
library(readxl)
library(grid)
library(likert)

library(pander)
panderOptions('digits', 2)
panderOptions('round', 2)
panderOptions('keep.trailing.zeros', TRUE)
options(scipen = 999)
options(digits = 3)

library(knitr)
#library(formattable)
library(kableExtra)
#library(xtable)
library(stargazer)
library(finalfit)

library(ggfortify)
library(survival)

library(Hmisc) #rcor
#library(ppcor) # pcor.test (partial correlation)
library(stringr)
#library(mediation)
#library(psych)
library(DescTools)
#library(vcd)
#library(desctable)
options(knitr.table.format = "pandoc")

knitr::opts_chunk$set(comment = NA)

library(captioner)
fig_caption <- captioner::captioner("Figure")
tab_caption <- captioner::captioner("Table")

options(knitr.table.format = "pandoc")
```

```{r Source scripts, message=F, warning=F, echo=F, results='hide'}
base_path = "~/Dropbox/Stats/"

source(paste0(base_path, 'R library/search_for_variable.R'), echo=F)
source(paste0(base_path, 'R library/mySSby.R'), echo=F)
source(paste0(base_path, 'R library/mySSby3.R'), echo=F) # replace finalfit
source(paste0(base_path, 'R library/describe_numerice1.R'), echo=F)
source(paste0(base_path, 'R library/contingency.R'), echo=F)
source(paste0(base_path, 'R library/describe2x2_v1.R'), echo=F)
source(paste0(base_path, 'R library/mytheme.R'), echo=F)
source(paste0(base_path, 'R library/assorted bits.R'), echo=F)
source(paste0(base_path, 'R library/custom_charts.R'), echo=F)

setwd(paste0(base_path, "2020/Regina Besinger"))
```


```{r Import data, echo=F, message=F, warning=F, fig.height=2.5, fig.width=6}
metadata <- suppressWarnings(read_excel("licenta Regine Besinger2.xlsx", sheet = "metadata"))

baza_de_date <- suppressWarnings(read_excel("licenta Regine Besinger2.xlsx", col_types = metadata$Type)) %>% 
  #mutate(`Invaliditate/Grad` = str_remove_all(`Invaliditate/Grad`, "x")) %>%
  labelled::set_variable_labels(.labels = metadata$Var) %>% 
  mutate_at(metadata$ID[ #metadata$Type %in% c("text") & 
    metadata$Role %in% c("danu" ,"binary", "factor", "ordered", "likert")], 
    as.factor_metadata, metadata=metadata) %>% 
  labelled::set_variable_labels(.labels = metadata$Label) %>%
  #select(-c("ID", "Nume")) %>%
  select(-c(metadata$Var[metadata$Role=="exclude"])) %>%
  select(-c(metadata$Var[metadata$Role=="id"]))

# for (col in metadata$Var[metadata$Role=="numeric"]) {
#   metadata <- update_var_metadata(DB = baza_de_date, metadata = metadata, var = col)
# 
#   #plot(my_histo(baza_de_date, col, NULL, metadata, F))
# }

# metadata <- make_metadata(baza_de_date, existing.metadata = metadata)
# write.csv(metadata, "metadata.csv", na = "")

my.groups <- list()

for (gr in unique(na.omit(metadata$Group))) {
  my.groups[[gr]] <- make_groups_metadata(gr, metadata)
}
baza_de_date %<>% select(unlist(my.groups, use.names = F))

# for (gr in sort(names(my.groups))) {
#   print(gr)
#   print(summary(baza_de_date[my.groups[[gr]]]))
# }
# summary(baza_de_date, maxsum = 10)
#DescTools::Desc(baza_de_date)

# summary(my.groups)
# my.groups

```

## Results

### Demographics

A total of 372 patients were includen din the study, of whom 60% were men. Age had values between 25 and 94 years old (median = 69) with a mean of 66.47 ±12.9 years old. Women were approximatively 5.36 years older on average than men (Mann-Whitney test: p<0.001).

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=144, results="asis", include=T}
cat("\n\n")
cat(tab_caption("t0.main","Demographic parameters of the sample."))
cat("\n\n")

baza_de_date %>% 
  select(c(my.groups$`Age special`, my.groups$Demographics )) %>% 
  make_summary_table(g.rows = c("mean_sd", "med_range"), metadata = metadata, 
   header=list(lang="en"), footnote=list(lang="en")) 

```

```{r echo=F, fig.height=2.5, fig.width=5, message=F, warning=F, dpi=144, results="asis", include=T}
pie_sex <- my_pie(baza_de_date, "Sex", metadata = metadata) +  
  scale_fill_brewer(metadata.var_to_labels("Sex", metadata), palette = "Set1")

# pie_sex

pie_AG <- my_pie(baza_de_date, "Age groups", metadata = metadata, lwd = 0.5) +  
  scale_fill_brewer(metadata.var_to_labels("Age groups", metadata), palette = "Dark2")

# pie_AG

cowplot::plot_grid(pie_sex, pie_AG, nrow=1)

cat("\n\n")
cat(fig_caption("pie.sex","Sex and age groups distribution."))
cat("\n\n")
```

<!-- `r paste0(demographics_text(baza_de_date), collapse=' ') ` -->

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=144, results="asis", include=T}

baza_de_date %>% #filter(`Grup` == "cazuri") %>%
  my_histo(numerica="Age (years)", categ="Sex", metadata = metadata) + 
  scale_fill_brewer(metadata.var_to_labels("Sex", metadata), palette = "Set1") +
  scale_color_brewer(metadata.var_to_labels("Sex", metadata), palette = "Set1") +
  scale_y_continuous(breaks = seq(0, 500, 50), limits=c(0, 150)) +
  #theme(legend.position = "none") + 
  labs(y="Cases")


cat("\n\n")
cat(fig_caption("histo_varsta","Age distribution, at admission, colored by sex. (| mean, ¦ median)."))
cat("\n\n")
```

### Durations

<!-- `r paste0(descriptives_text(baza_de_date, numerice = my.groups$Durations, sex = NA), collapse='\n\n') ` -->

It took up to 4 hours after clinical onset for patients to present to the emergency unit, with a median of 1.6 hours. Then, it further took up to 3.5 hours to initiate fibrinolytic treatment (median=1 hour), for a total of up to 4.5 hours between onset to treatment (median=2.8 hours). 

Only 5% of the patients started treatment after more than 2 hours after presentaion.

CT imaging and laboratory analyses took up to 4.5 hours to complete (medians of 2.3 and 2.1 hours).

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=144, results="asis", include=T}
cat("\n\n")
cat(tab_caption("t0.duration","."))
cat("\n\n")

# paste0(descriptives_text(baza_de_date, numerice = my.groups$Durations, sex = NA), collapse=' ')

baza_de_date %>% 
  select(c( my.groups$Durations,my.groups$`Durations special`)) %>% 
  make_summary_table(g.rows = c("mean_sd", "med_range"), metadata = metadata, 
   header=list(lang="en"), footnote=list(lang="en")) 

```

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=144, results="asis", include=T}
cat("\n\n")
cat(fig_caption("boxes.duration","."))
cat("\n\n")

db <- baza_de_date %>% select(c(my.groups$Durations)) %>%
  tidyr::gather("Duration", "Time") %>%
  # mutate(`Duration` = `Duration` %>% str_remove_all("Time ") %>% str_remove_all(" \\(hours\\)")) %>%
  mutate(`Duration` = factor(str_remove_all(`Duration`, "Time ")%>% str_remove_all(" \\(hours\\)"), 
                         levels=str_remove_all(my.groups$Durations, "Time ") %>% 
                           str_remove_all(" \\(hours\\)")) %>% relevel(5)) %>%
  # mutate(`Duration` = as.factor(`Duration`))  %>%
  # filter(Operation != "cephalic duodenopancreatectomy\nafter stentation") %>%
  na.omit() %>% droplevels() 

my_box(db=db, y = "Time", x="Duration", metadata = make_metadata(db)) +
  no_legend +
  coord_flip()

```

```{r echo=F, fig.height=4, fig.width=5, message=F, warning=F, dpi=144, results="asis", include=T}


db <- baza_de_date %>% select(c(my.groups$Durations)) %>%
  tidyr::gather("Duration", "Time") %>%
  mutate(`Duration` = `Duration` %>% str_remove_all("Time ") %>% str_remove_all(" \\(hours\\)")) %>%
  mutate(`nothing` = "", `no_censor` = T) %>%
  set_colnames(c("Duration", "Time", "nothing", "no_censor")) %>% 
  # filter(Operation != "cephalic duodenopancreatectomy\nafter stentation") %>%
  na.omit() %>% droplevels()
#summary(db)

fit <- with(db, survfit(formula=Surv(time = `Time`, event = `no_censor`) ~ `Duration`))

surv_median <- as.vector(summary(fit)$table[, "median"])
df_fit <- data.frame(
  strata2 = names(fit$strata) %>% str_remove_all("Duration="),
  x1 = surv_median, x2 = surv_median, 
  y1 = rep(0, length(surv_median)), 
  y2 = rep(0.5, length(surv_median))) %>%
  mutate(`strata2`= as.character(strata2)) %>%
  arrange(x1)

sorted.levels <- df_fit$strata2

df_fit$strata2 <- factor(as.character(df_fit$strata2), levels = sorted.levels)

plot.data = fortify(fit, surv.connect = T, censor=T) 
plot.data$strata <- factor(as.character(plot.data$strata), levels = sorted.levels)
p1 <- ggplot(plot.data, aes(x=time, y=surv)) +
  geom_step(aes(color=strata), size=0.5) +
    

# p1 <- autoplot(fit, conf.int = F, surv.connect = T, conf.int.alpha = 0.05,
#    censor = T, censor.size = 2.5, censor.shape = "|")+
  scale_x_continuous("Time (hours)", limits=c(0, 5)) +
  scale_y_continuous("Proportion of cases (%)", expand = expand_scale(mult=0.01),
   breaks = seq(0, 1, 0.1), labels = scales::percent_format(1) ) +
  geom_hline(yintercept=0.5, size=0.5, color="grey") +
  geom_segment(aes(x = x1, y=0, xend=x1, yend=0.5, color=strata2), data=df_fit, linetype = "dashed", size = 0.5) +
  labs(color="Duration") +
  # scale_color_viridis_d()+
  theme(plot.margin = margin(t=-25, b=1, l=1, r=1, "mm"))# + legend.bottom_left
  
p2 <- db %>% 
  mutate(`Duration` = factor(as.character(`Duration`), levels=sorted.levels)) %>%
  ggplot(aes(x=`Duration`, y=`Time`, fill=`Duration`)) +
  # scale_color_viridis_d() +
  #geom_tufteboxplot(size=1, ) + 
  geom_boxplot(width=0.5, outlier.shape = "|", size=0.25)+
  coord_flip() + 
  scale_y_continuous("Time (hours)", limits=c(0, 5)) +
  no_legend + no.labels.y + no.ticks.y + no.title.y + no.title.x +
  theme(plot.margin = margin(t=0, b=-25, l=1, r=1, "mm"))
 
cowplot::plot_grid(p2, p1, nrow = 2, rel_heights = c(3.333, 10), align = "hv", axis="tblr")

# data.frame(rank(df_fit$x1), df_fit$x1*60,as.character(sorted.levels))
```

### Scores

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=144, results="asis", include=T}
cat("\n\n")
cat(tab_caption("t0.scores1","."))
cat("\n\n")

baza_de_date %>% 
  select(c( my.groups$NIHSS )) %>% 
  make_summary_table(g.rows = c("mean_sd", "med_range"), metadata = metadata, 
   header=list(lang="en"), footnote=list(lang="en")) 

```

The average NIHSS score decreased within the first week after admission form approximatively 11.77 ±5.7 to about 5.25 ±6.0. At admission, half of the patients had NIHSS values 11 while after 7 days, the median dropped to 3. Meanwhile the distribution of NIHSS values evolves more concentrated towards 0, with fewer and fewer patients with high scores.

```{r echo=F, fig.height=2.5, fig.width=2.5, message=F, warning=F, dpi=144, results="asis", include=T}
for (var in c(my.groups$NIHSS) ) {
  p <- baza_de_date %>% my_histo(var, metadata = metadata ) +
    scale_y_continuous("Cases", breaks=seq(0, 1000, 50)) + 
    labs(y="Cases")
  plot(p)
  
  cat("\n\n")
  cat(fig_caption("histo" %+% var,""))
  cat("\n\n")
}

```

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=144, results="asis", include=T}
cat("\n\n")
cat(fig_caption("boxes.NIHSS","."))
cat("\n\n")

db <- baza_de_date %>% select(c(my.groups$NIHSS)) %>%
  tidyr::gather("Time", "NIHSS") %>%
  mutate(`Time` = factor(str_remove_all(`Time`, "NIHSS score "), 
                         levels=str_remove_all(my.groups$NIHSS, "NIHSS score "))) %>%
  # filter(Operation != "cephalic duodenopancreatectomy\nafter stentation") %>%
  na.omit() %>% droplevels() 

my_box(db=db, y = "NIHSS", x="Time", metadata = make_metadata(db)) +
  no_legend +
  coord_flip()

```

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=144, results="asis", include=T}
cat("\n\n")
cat(tab_caption("t0.scores2","."))
cat("\n\n")

baza_de_date %>% 
  select(c( my.groups$`Rankin special`, my.groups$Rankin, 
            my.groups$`Barthel special`, my.groups$Barthel )) %>% 
  make_summary_table(g.rows = c("mean_sd", "med_range"), metadata = metadata, 
   header=list(lang="en"), footnote=list(lang="en")) 

```

Between discharge and the follow-up at 3 months, the average Rankin score decreased from 3.91 ±1.9 to 3.38 ±2.04. At follow-up, the average Barthel index acheived an average value of 14.3 ±7.1, with more than 40% of the patients having the maximum value of 20.

```{r echo=F, fig.height=2.5, fig.width=2.5, message=F, warning=F, dpi=144, results="asis", include=T}
for (var in c(my.groups$Rankin) ) {
  p <- baza_de_date %>% 
    mutate_at(var, as.factor) %>%
    my_bar(var = var, metadata = metadata, flip = T, fill = "..count..", two.lines.labels = F) +
    scale_y_continuous("Cases (% of available data)", 
                       breaks=seq(0, 1, 0.05), limits = c(0, 0.31), 
                       labels=scales::percent_format(1)) +
    no_legend +
    scale_fill_viridis_c()
  plot(p)
  
  cat("\n\n")
  cat(fig_caption("histo" %+% var,""))
  cat("\n\n")
}

```

```{r echo=F, fig.height=2.5, fig.width=2.5, message=F, warning=F, dpi=144, results="asis", include=T}

baza_de_date %>% my_histo("Barthel Index at 3 months", metadata = metadata ) +
  scale_y_continuous("Cases", breaks=seq(0, 1000, 25)) + 
  labs(y="Cases")


cat("\n\n")
cat(fig_caption("histo" %+% "Barthel Index at 3 months","Barthel Index at 3 months"))
cat("\n\n")


```

### Correls

<!-- The linear correlation between the duration of onset of symptoms until thrombolytic administration and NIHSS scores, Rankin score, Barthel index, hemorrhagic transformation -->

Higher of average HIHSS scores were weakly correlated to the duration between the onset of symptoms until thrombolytic administration. Only at 2 and 24 hours was this correlation statistically significant (Spearman R = 0.11, p=0.032 and R=0.12, p=0.026, respectively). Similarly, neither Rankin score, nor Barthel index were signifficantly correlated to this duration, even after adjusting for age. Hemorrhagic transformation was not found significantly influenced by time between clnical onset and treatment (T-test: p=0.40).

```{r echo=F, fig.height=2.5, fig.width=2.5, message=F, warning=F, dpi=144, results="asis", include=T}
var.x = "Time onset - treatment start (hours)"
for (var in c(my.groups$NIHSS, my.groups$Rankin, my.groups$Barthel) ) {
  p <- baza_de_date %>% my_scatter(var.x, var, metadata = metadata ) + no_legend
  plot(p)
  
  cat("\n\n")
  cat(fig_caption("scatter" %+% var.x %+% var,""))
  cat("\n\n")
}

```

<!-- 13. Correlation between medium duration of onset of symptoms until thrombolytic administration and rate of  -->

```{r echo=F, fig.height=2.5, fig.width=2.5, message=F, warning=F, dpi=144, results="asis", include=T}
baza_de_date %>% 
  my_box(x = "Hemorrhagic transformation", 
         y = "Time onset - treatment start (hours)", 
         metadata = metadata, varwidth = T) + 
  ggpubr::stat_compare_means(method = "t.test", label.sep = ": ", size=3)+
  no_legend


cat("\n\n")
cat(fig_caption("box.q13",""))
cat("\n\n")


```

<!-- 14. Correlation between medium duration of onset of symptoms until the treatment and Rankin score at 3 months, in the different age groups -->

```{r echo=F, fig.height=2.5, fig.width=5, message=F, warning=F, dpi=144, results="asis", include=T}
var.x = "Time onset - treatment start (hours)"
var.y = "Rankin score at 3 months"
baza_de_date %>% 
  filter (!is.na(`Age groups`)) %>%
  my_scatter(x = "Time onset - treatment start (hours)", 
             y = "Rankin score at 3 months", 
             color = "Age groups",
             metadata = metadata, alpha = 0.75) +  
  scale_fill_brewer(metadata.var_to_labels("Age groups", metadata), palette = "Dark2")  +
  scale_color_brewer(metadata.var_to_labels("Age groups", metadata), palette = "Dark2")

cat("\n\n")
cat(fig_caption("scatterq14.1" ,""))
cat("\n\n")

```

```{r echo=F, fig.height=2.5, fig.width=5, message=F, warning=F, dpi=144, results="asis", include=T}
var.x = "Time onset - treatment start (hours)"
var.y = "Barthel Index at 3 months"
baza_de_date %>% 
  filter (!is.na(`Age (years)`)) %>%
  my_scatter(x = "Time onset - treatment start (hours)", 
             y = "Rankin score at 3 months", 
             color = "Age (years)",
             metadata = metadata, alpha = 0.75 ) + 
  scale_fill_distiller(metadata.var_to_labels("Age (years)", metadata), 
                       palette = "Spectral", breaks=seq(0, 100, 25), limits=c(25, 100))

cat("\n\n")
cat(fig_caption("scatterq14.2" ,""))
cat("\n\n")

```

<!-- 15. Correlation between medium duration of onset of symptoms until treatment and Barthel index at 3 months, in the different age groups -->

```{r echo=F, fig.height=2.5, fig.width=5, message=F, warning=F, dpi=144, results="asis", include=T}

baza_de_date %>% 
  filter (!is.na(`Age groups`)) %>%
  my_scatter(x = "Time onset - treatment start (hours)", 
             y = "Barthel Index at 3 months", 
             color = "Age groups",
             metadata = metadata, alpha = 0.75, max_size = 4 )  +  
  scale_fill_brewer(metadata.var_to_labels("Age groups", metadata), palette = "Dark2")  +
  scale_color_brewer(metadata.var_to_labels("Age groups", metadata), palette = "Dark2")

cat("\n\n")
cat(fig_caption("scatterq15.1" ,""))
cat("\n\n")

```

```{r echo=F, fig.height=2.5, fig.width=5, message=F, warning=F, dpi=144, results="asis", include=T}

baza_de_date %>% 
  filter (!is.na(`Age (years)`)) %>%
  my_scatter(x = "Time onset - treatment start (hours)", 
             y = "Barthel Index at 3 months", 
             color = "Age (years)",
             metadata = metadata, alpha = 0.75 ) + 
  scale_fill_distiller(metadata.var_to_labels("Age (years)", metadata), 
                       palette = "Spectral", breaks=seq(0, 100, 25), limits=c(25, 100))

cat("\n\n")
cat(fig_caption("scatterq14.2" ,""))
cat("\n\n")

```

# Demo

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=144, results="asis", include=T}
my_surv_plot <- function(db, time_var, by, metadata) {
  # by = "Age groups"
  
  db <- baza_de_date %>% select(c(time_var, by, "no_censor")) %>%
    mutate(`no_censor` = `no_censor`=="no") %>%
    mutate(nothing = "") %>%
    set_colnames(c("Survival", "by", "Dead", "nothing")) %>% 
    # filter(Operation != "cephalic duodenopancreatectomy\nafter stentation") %>%
    na.omit() %>% droplevels()
  #summary(db)
  
  fit <- with(db, survfit(formula=as.formula("Surv(time = `Survival`, event = `Dead`) ~ " %+% .("by")) ))
  
  test <- with(db, survival::survdiff(as.formula("Surv(time = `Survival`, event = `Dead`) ~ " %+% .("by")) ))
  p <- pchisq(test$chisq, length(test$n)-1, lower.tail = FALSE)
  
  surv_median <- as.vector(summary(fit)$table[, "median"])
  df_fit <- data.frame(
    strata2 = names(fit$strata) %>% str_remove_all("by" %+% "="),
    x1 = surv_median, x2 = surv_median, 
    y1 = rep(0, length(surv_median)), 
    y2 = rep(0.5, length(surv_median)))
  
  p <- autoplot(fit, conf.int = T, surv.connect = T, conf.int.alpha = 0.1,
                censor = T, censor.size = 2.5, censor.shape = "|")+
    scale_x_continuous(metadata.var_to_labels(time_var, metadata) %>% str_wrap(30), 
     expand = expand_scale(mult=0.01),
     limits=c(0, metadata$Max[metadata$Var==time_var]), 
     breaks=metadata$Breaks[metadata$Var==time_var] %>% str_split(";", simplify = T) %>% as.numeric())+
    scale_y_continuous("Proportion of cases (%)", expand = expand_scale(mult=0.01),
     breaks = seq(0, 1, 0.1), labels = scales::percent_format(1) ) +
    # scale_color_viridis_d(by) + scale_fill_viridis_d(by)+
    labs(color=by, fill=by) +
    labs(subtitle = "Log-rank test: " %+% scales::pvalue(p)) +
    geom_hline(yintercept=0.5, size=0.5, color="grey") +
    geom_vline(aes(xintercept=x1, color=strata2), data=df_fit, linetype = "dashed", size = 0.5) 
  
  p
}


# time_var = "Time onset - presentation (hours)"
# by = "Sex"
# my_surv_plot(baza_de_date, time_var,by, metadata)

```

```{r echo=F, fig.height=2.5, fig.width=2.5, message=F, warning=F, dpi=144, results="asis", include=T}
for (var in c(my.groups$Durations) ) {
  p <- baza_de_date %>% my_surv_plot(time_var = var, by = "Sex", metadata) + 
    scale_color_brewer(metadata.var_to_labels("Sex", metadata), palette = "Set1") + 
    scale_fill_brewer(metadata.var_to_labels("Sex", metadata), palette = "Set1")
  plot(p)
  
  cat("\n\n")
  cat(fig_caption("survplot.sex" %+% var,""))
  cat("\n\n")
}

```

```{r echo=F, fig.height=2.5, fig.width=2.5, message=F, warning=F, dpi=144, results="asis", include=T}
for (var in c(my.groups$Durations) ) {
  p <- baza_de_date %>% my_surv_plot(time_var = var, by = "Age groups", metadata)  +  
    scale_fill_brewer(metadata.var_to_labels("Age groups", metadata), palette = "Dark2")  +
    scale_color_brewer(metadata.var_to_labels("Age groups", metadata), palette = "Dark2")
  plot(p)
  
  cat("\n\n")
  cat(fig_caption("survplot.age" %+% var,""))
  cat("\n\n")
}

```

```{r echo=F, fig.height=2.5, fig.width=2.5, message=F, warning=F, dpi=144, results="asis", include=T}
for (var in c(my.groups$Durations) ) {
  p <- baza_de_date %>% my_histo(var, metadata = metadata ) +
    scale_y_continuous("Cases", breaks=seq(0, 1000, 50)) + 
    labs(y="Cases")
  plot(p)
  
  cat("\n\n")
  cat(fig_caption("histo" %+% var,""))
  cat("\n\n")
}

```

```{r echo=F, fig.height=6, fig.width=5, message=F, warning=F, dpi=144, results="asis", include=T}
mc <- multicor(baza_de_date, y = my.groups$Durations, x=c(my.groups$NIHSS,my.groups$Rankin, my.groups$Barthel, my.groups$ASPECT), metadata = metadata, wrap.x = 30, wrap.y = 15, limits = c(-0.5, 0.5))

mc$p
```

```{r echo=F, fig.height=6, fig.width=5, message=F, warning=F, dpi=144, results="asis", include=T}

mc$t
```

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=144, results="asis", include=T}
cat("\n\n")
cat(tab_caption("t0.all","."))
cat("\n\n")

baza_de_date %>% 
  select(-c("no_censor")) %>%
  make_summary_table(dep="Hemorrhagic transformation", 
                     g.rows = c("mean_sd", "med_range"), metadata = metadata, 
   header=list(lang="en"), footnote=list(lang="en")) 

```

# References

1. R Core Team (2020). R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL https://www.R-project.org/.

